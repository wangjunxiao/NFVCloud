Custom J\+S\+O\+N-\/\+Schema keywords for \href{https://github.com/epoberezkin/ajv}{\tt ajv} validator

\href{https://travis-ci.org/epoberezkin/ajv-keywords}{\tt } \href{https://www.npmjs.com/package/ajv-keywords}{\tt } \href{https://www.npmjs.com/package/ajv-keywords}{\tt } \href{https://coveralls.io/github/epoberezkin/ajv-keywords?branch=master}{\tt }

\subsection*{Contents}


\begin{DoxyItemize}
\item \href{#install}{\tt Install}
\item \href{#usage}{\tt Usage}
\item \href{#keywords}{\tt Keywords}
\begin{DoxyItemize}
\item \href{#typeof}{\tt typeof}
\item \href{#instanceof}{\tt instanceof}
\item \href{#range-and-exclusiverange}{\tt range and exclusive\+Range}
\item \href{#propertynames}{\tt property\+Names}
\item \href{#ifthenelse}{\tt if/then/else}
\item \href{#prohibited}{\tt prohibited}
\item \href{#deepproperties}{\tt deep\+Properties}
\item \href{#deeprequired}{\tt deep\+Required}
\item \href{#regexp}{\tt regexp}
\item \href{#dynamicdefaults}{\tt dynamic\+Defaults}
\end{DoxyItemize}
\item \href{#license}{\tt License}
\end{DoxyItemize}

\subsection*{Install}


\begin{DoxyCode}
npm install ajv-keywords
\end{DoxyCode}


\subsection*{Usage}

To add all available keywords\+:


\begin{DoxyCode}
var Ajv = require('ajv');
var ajv = new Ajv;
require('ajv-keywords')(ajv);

ajv.validate(\{ instanceof: 'RegExp' \}, /.*/); // true
ajv.validate(\{ instanceof: 'RegExp' \}, '.*'); // false
\end{DoxyCode}


To add a single keyword\+:


\begin{DoxyCode}
require('ajv-keywords')(ajv, 'instanceof');
\end{DoxyCode}


To add multiple keywords\+:


\begin{DoxyCode}
require('ajv-keywords')(ajv, ['typeof', 'instanceof']);
\end{DoxyCode}


To add a single keyword in browser (to avoid adding unused code)\+:


\begin{DoxyCode}
require('ajv-keywords/keywords/instanceof')(ajv);
\end{DoxyCode}


\subsection*{Keywords}

\subsubsection*{{\ttfamily typeof}}

Based on Java\+Script {\ttfamily typeof} operation.

The value of the keyword should be a string ({\ttfamily \char`\"{}undefined\char`\"{}}, {\ttfamily \char`\"{}string\char`\"{}}, {\ttfamily \char`\"{}number\char`\"{}}, {\ttfamily \char`\"{}object\char`\"{}}, {\ttfamily \char`\"{}function\char`\"{}}, {\ttfamily \char`\"{}boolean\char`\"{}} or {\ttfamily \char`\"{}symbol\char`\"{}}) or array of strings.

To pass validation the result of {\ttfamily typeof} operation on the value should be equal to the string (or one of the strings in the array).


\begin{DoxyCode}
ajv.validate(\{ typeof: 'undefined' \}, undefined); // true
ajv.validate(\{ typeof: 'undefined' \}, null); // false
ajv.validate(\{ typeof: ['undefined', 'object'] \}, null); // true
\end{DoxyCode}


\subsubsection*{{\ttfamily instanceof}}

Based on Java\+Script {\ttfamily instanceof} operation.

The value of the keyword should be a string ({\ttfamily \char`\"{}\+Object\char`\"{}}, {\ttfamily \char`\"{}\+Array\char`\"{}}, {\ttfamily \char`\"{}\+Function\char`\"{}}, {\ttfamily \char`\"{}\+Number\char`\"{}}, {\ttfamily \char`\"{}\+String\char`\"{}}, {\ttfamily \char`\"{}\+Date\char`\"{}}, {\ttfamily \char`\"{}\+Reg\+Exp\char`\"{}} or {\ttfamily \char`\"{}\+Buffer\char`\"{}}) or array of strings.

To pass validation the result of {\ttfamily data instanceof ...} operation on the value should be true\+:


\begin{DoxyCode}
ajv.validate(\{ instanceof: 'Array' \}, []); // true
ajv.validate(\{ instanceof: 'Array' \}, \{\}); // false
ajv.validate(\{ instanceof: ['Array', 'Function'] \}, funciton()\{\}); // true
\end{DoxyCode}


You can add your own constructor function to be recognised by this keyword\+:


\begin{DoxyCode}
function MyClass() \{\}
var instanceofDefinition = require('ajv-keywords').get('instanceof').definition;
// or require('ajv-keywords/keywords/instanceof').definition;
instanceofDefinition.CONSTRUCTORS.MyClass = MyClass;

ajv.validate(\{ instanceof: 'MyClass' \}, new MyClass); // true
\end{DoxyCode}


\subsubsection*{{\ttfamily range} and {\ttfamily exclusive\+Range}}

Syntax sugar for the combination of minimum and maximum keywords, also fails schema compilation if there are no numbers in the range.

The value of this keyword must be the array consisting of two numbers, the second must be greater or equal than the first one.

If the validated value is not a number the validation passes, otherwise to pass validation the value should be greater (or equal) than the first number and smaller (or equal) than the second number in the array. If {\ttfamily exclusive\+Range} keyword is present in the same schema and its value is true, the validated value must not be equal to the range boundaries.


\begin{DoxyCode}
var schema = \{ range: [1, 3] \};
ajv.validate(schema, 1); // true
ajv.validate(schema, 2); // true
ajv.validate(schema, 3); // true
ajv.validate(schema, 0.99); // false
ajv.validate(schema, 3.01); // false

var schema = \{ range: [1, 3], exclusiveRange: true \};
ajv.validate(schema, 1.01); // true
ajv.validate(schema, 2); // true
ajv.validate(schema, 2.99); // true
ajv.validate(schema, 1); // false
ajv.validate(schema, 3); // false
\end{DoxyCode}


\subsubsection*{{\ttfamily property\+Names}}

This keyword allows to define the schema for the property names of the object. The value of this keyword should be a valid J\+S\+ON schema (v5 schemas are supported with Ajv option {\ttfamily \{v5\+: true\}}).


\begin{DoxyCode}
var schema = \{
  type: 'object'
  propertyNames: \{
    anyOf: [
      \{ format: ipv4 \},
      \{ format: hostname \}
    ]
  \}
\};

var validData = \{
  '192.128.0.1': \{\},
  'test.example.com': \{\}
\};

var invalidData = \{
  '1.2.3': \{\}
\};

ajv.validate(schema, validData); // true
ajv.validate(schema, invalidData); // false
\end{DoxyCode}


{\bfseries Please note}\+: This keyword will be added to the next version of the J\+S\+O\+N-\/\+Schema standard (draft-\/6), after it is published the keyword will be included in Ajv as standard validation keyword.

\subsubsection*{{\ttfamily if}/{\ttfamily then}/{\ttfamily else}}

These keywords allow to implement conditional validation. Their values should be valid J\+S\+O\+N-\/schemas. At the moment it requires using Ajv with v5 option.

If the data is valid according to the sub-\/schema in {\ttfamily if} keyword, then the result is equal to the result of data validation against the sub-\/schema in {\ttfamily then} keyword, otherwise -\/ in {\ttfamily else} keyword (if {\ttfamily else} is absent, the validation succeeds).


\begin{DoxyCode}
require('ajv-keywords')(ajv, 'if');

var schema = \{
  type: 'array',
  items: \{
    type: 'integer',
    minimum: 1,
    if: \{ maximum: 10 \},
    then: \{ multipleOf: 2 \},
    else: \{ multipleOf: 5 \}
  \}
\};

var validItems = [ 2, 4, 6, 8, 10, 15, 20, 25 ]; // etc.

var invalidItems = [ 1, 3, 5, 11, 12 ]; // etc.

ajv.validate(schema, validItems); // true
ajv.validate(schema, invalidItems); // false
\end{DoxyCode}


This keyword is \href{https://github.com/json-schema-org/json-schema-spec/issues/180}{\tt proposed} for the future version of J\+S\+O\+N-\/\+Schema standard.

\subsubsection*{{\ttfamily prohibited}}

This keyword allows to prohibit that any of the properties in the list is present in the object.

This keyword applies only to objects. If the data is not an object, the validation succeeds.

The value of this keyword should be an array of strings, each string being a property name. For data object to be valid none of the properties in this array should be present in the object.


\begin{DoxyCode}
var schema = \{ prohibited: ['foo', 'bar']\};

var validData = \{ baz: 1 \};
var alsoValidData = \{\};

var invalidDataList = [
  \{ foo: 1 \},
  \{ bar: 2 \},
  \{ foo: 1, bar: 2\}
];
\end{DoxyCode}


\subsubsection*{{\ttfamily deep\+Required}}

This keyword allows to check that some deep properties (identified by J\+S\+ON pointers) are available. The value should be an array of J\+S\+ON pointers to the data, starting from the current position in data.


\begin{DoxyCode}
var schema = \{
  type: 'object',
  deepRequired: ["/users/1/role"]
\};

var validData = \{
  users: [
    \{\},
    \{
      id: 123,
      role: 'admin'
    \}
  ]
\};

var invalidData = \{
  users: [
    \{\},
    \{
      id: 123
    \}
  ]
\};
\end{DoxyCode}


See \href{https://github.com/json-schema-org/json-schema-spec/issues/203#issue-197211916}{\tt json-\/schema-\/org/json-\/schema-\/spec\#203} for an example of the equivalent schema without {\ttfamily deep\+Required} keyword.

\subsection*{{\ttfamily deep\+Properties}}

This keyword allows to validate deep properties (identified by J\+S\+ON pointers). The value should be an object, where keys are J\+S\+ON pointers to the data, starting from the current position in data, and the values are corresponding schemas.


\begin{DoxyCode}
var schema = \{
  type: 'object',
  deepProperties: \{
    "/users/1/role": \{ "enum": ["admin"] \}
  \}
\};

var validData = \{
  users: [
    \{\},
    \{
      id: 123,
      role: 'admin'
    \}
  ]
\};

var alsoValidData = \{
  users: \{
    "1": \{
      id: 123,
      role: 'admin'
    \}
  \}
\};

var invalidData = \{
  users: [
    \{\},
    \{
      id: 123,
      role: 'user'
    \}
  ]
\};

var alsoInvalidData = \{
  users: \{
    "1": \{
      id: 123,
      role: 'user'
    \}
  \}
\};
\end{DoxyCode}


\subsubsection*{{\ttfamily regexp}}

This keyword allows to use regular expressions with flags in schemas (the standard {\ttfamily pattern} keyword does not support flags). The value of this keyword can be either a string (the result of {\ttfamily regexp.\+to\+String()}) or an object with the properties {\ttfamily pattern} and {\ttfamily flags} (the same strings that should be passed to Reg\+Exp constructor).


\begin{DoxyCode}
var schema = \{
  type: 'object',
  properties: \{
    foo: \{ regexp: '/foo/i' \},
    bar: \{ regexp: \{ pattern: 'bar', flags: 'i' \} \}
  \}
\};

var validData = \{
  foo: 'Food',
  bar: 'Barmen'
\};

var invalidData = \{
  foo: 'fog',
  bar: 'bad'
\};
\end{DoxyCode}


\subsubsection*{{\ttfamily dynamic\+Defaults}}

This keyword allows to assign dynamic defaults to properties, such as timestamps, unique I\+Ds etc.

This keyword only works if {\ttfamily use\+Defaults} options is used and not inside {\ttfamily any\+Of} keywrods etc., in the same way as \href{https://github.com/epoberezkin/ajv#assigning-defaults}{\tt default keyword treated by Ajv}.

The keyword should be added on the object level. Its value should be an object with each property corresponding to a property name, in the same way as in standard {\ttfamily properties} keyword. The value of each property can be\+:


\begin{DoxyItemize}
\item an identifier of default function (a string)
\item an object with properties {\ttfamily func} (an identifier) and {\ttfamily args} (an object with parameters that will be passed to this function during schema compilation -\/ see examples).
\end{DoxyItemize}

The properties used in {\ttfamily dynamic\+Defaults} should not be added to {\ttfamily required} keyword (or validation will fail), because unlike {\ttfamily default} this keyword is processed after validation.

There are several predefined dynamic default functions\+:


\begin{DoxyItemize}
\item {\ttfamily \char`\"{}timestamp\char`\"{}} -\/ current timestamp in milliseconds
\item {\ttfamily \char`\"{}datetime\char`\"{}} -\/ current date and time as string (I\+SO, valid according to {\ttfamily date-\/time} format)
\item {\ttfamily \char`\"{}date\char`\"{}} -\/ current date as string (I\+SO, valid according to {\ttfamily date} format)
\item {\ttfamily \char`\"{}time\char`\"{}} -\/ current time as string (I\+SO, valid according to {\ttfamily time} format)
\item {\ttfamily \char`\"{}random\char`\"{}} -\/ pseudo-\/random number in \mbox{[}0, 1) interval
\item {\ttfamily \char`\"{}randomint\char`\"{}} -\/ pseudo-\/random integer number. If string is used as a property value, the function will randomly return 0 or 1. If object `\{func\+: \textquotesingle{}randomint', max\+: N\}{\ttfamily is used then the default will be an integer number in \mbox{[}0, N) interval. -\/}\char`\"{}seq\char`\"{}{\ttfamily -\/ sequential integer number starting from 0. If string is used as a property value, the default sequence will be used. If object}\{func\+: \textquotesingle{}seq\textquotesingle{}, name\+: \textquotesingle{}foo\textquotesingle{}\}{\ttfamily is used then the sequence with name}\char`\"{}foo\char`\"{}\`{} will be used. Sequences are global, even if different ajv instances are used.
\end{DoxyItemize}


\begin{DoxyCode}
var schema = \{
  type: 'object',
  dynamicDefaults: \{
    ts: 'datetime',
    r: \{ func: 'randomint', max: 100 \},
    id: \{ func: 'seq', name: 'id' \}
  \},
  properties: \{
    ts: \{
      type: 'string',
      format: 'datetime'
    \},
    r: \{
      type: 'integer',
      minimum: 0,
      maximum: 100,
      exclusiveMaximum: true
    \},
    id: \{
      type: 'integer',
      minimum: 0
    \}
  \}
\};

var data = \{\};
ajv.validate(data); // true
data; // \{ ts: '2016-12-01T22:07:28.829Z', r: 25, id: 0 \}

var data1 = \{\};
ajv.validate(data1); // true
data1; // \{ ts: '2016-12-01T22:07:29.832Z', r: 68, id: 1 \}

ajv.validate(data1); // true
data1; // didn't change, as all properties were defined
\end{DoxyCode}


You can add your own dynamic default function to be recognised by this keyword\+:


\begin{DoxyCode}
var uuid = require('uuid');

function uuidV4() \{ return uuid.v4(); \}

var definition = require('ajv-keywords').get('dynamicDefaults').definition;
// or require('ajv-keywords/keywords/dynamicDefaults').definition;
definition.DEFAULTS.uuid = uuidV4;

var schema = \{
  dynamicDefaults: \{ id: 'uuid' \},
  properties: \{ id: \{ type: 'string', format: 'uuid' \} \}
\};

var data = \{\};
ajv.validate(schema, data); // true
data; // \{ id: 'a1183fbe-697b-4030-9bcc-cfeb282a9150' \};

var data1 = \{\};
ajv.validate(schema, data1); // true
data1; // \{ id: '5b008de7-1669-467a-a5c6-70fa244d7209' \}
\end{DoxyCode}


You also can define dynamic default that accepts parameters, e.\+g. version of uuid\+:


\begin{DoxyCode}
var uuid = require('uuid');

function getUuid(args) \{
  var version = 'v' + (arvs && args.v || 4);
  return function() \{
    return uuid[version]();
  \};
\}

var definition = require('ajv-keywords').get('dynamicDefaults').definition;
definition.DEFAULTS.uuid = getUuid;

var schema = \{
  dynamicDefaults: \{
    id1: 'uuid', // v4
    id2: \{ func: 'uuid', v: 4 \}, // v4
    id3: \{ func: 'uuid', v: 1 \} // v1
  \}
\};
\end{DoxyCode}


\subsection*{License}

\href{https://github.com/JSONScript/ajv-keywords/blob/master/LICENSE}{\tt M\+IT} 